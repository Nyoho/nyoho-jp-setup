upstream tdiary {
       server localhost:8080;
}

upstream hiki {
       server localhost:9292;
}

server {
       #listen   80; ## listen for ipv4; this line is default and implied
       #listen   [::]:80 default_server ipv6only=on; ## listen for ipv6

       root /var/www/nyoho.jp;
       index index.html index.htm;

       server_name nyoho.jp;

       location = /diary {
               rewrite ^ /diary/ redirect;
       }

       location = /tdiary {
               rewrite ^ /diary/ redirect;
       }

       location ~ ^/tdiary {
               rewrite ^/tdiary/(.*)$ /diary/$1 redirect;
       }

       location ~ ^/diary/ {
               rewrite ([0-9\-]+)\.html$ /diary/index.rb?date=$1 last;
               proxy_pass http://tdiary;
       }

       location = ^/wiki {
               rewrite ^ /wiki/ redirect;
       }

       location = ^/hiki {
               rewrite ^ /wiki/ redirect;
       }

       location ~ ^/hiki {
               rewrite ^/hiki/(.*)$ /wiki/$1 redirect;
       }

       location ~ ^/wiki/ {
               proxy_pass http://hiki;
       }
}
